<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ReiseRadar">
<meta name="theme-color" content="#f0a500">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icons/icon-192.png">
<title>ReiseRadar ‚Äî KI Reisesuche</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  :root{--gold:#f0a500;--orange:#ff6b35;--green:#2ecc71;--purple:#9b59b6;--blue:#3498db;--red:#e74c3c;--teal:#1abc9c;--cruise:#0077b6;--nile:#c9a227}
  body{min-height:100vh;min-height:100dvh;background:linear-gradient(160deg,#0a0a1a 0%,#0f1729 40%,#0a0a1a 100%);font-family:'DM Sans',sans-serif;color:#f0f0f0;overflow-x:hidden;-webkit-font-smoothing:antialiased}
  body::before{content:'';position:fixed;top:-200px;right:-200px;width:500px;height:500px;border-radius:50%;background:radial-gradient(circle,rgba(240,165,0,0.06) 0%,transparent 70%);pointer-events:none;z-index:0}

  .container{max-width:860px;margin:0 auto;padding:24px 14px;padding-top:env(safe-area-inset-top,24px);position:relative;z-index:1}
  .header{text-align:center;margin-bottom:20px}
  .header-icon{font-size:44px;margin-bottom:6px;animation:float 3s ease-in-out infinite}
  .header h1{font-family:'Playfair Display',serif;font-size:clamp(26px,6vw,42px);font-weight:800;background:linear-gradient(135deg,var(--gold),var(--orange),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1.2}
  .header p{color:#888;font-size:12px;margin-top:4px}

  .badges{display:flex;justify-content:center;gap:6px;margin-bottom:18px;flex-wrap:wrap}
  .badge{padding:4px 10px;font-size:10px;font-weight:500;background:rgba(255,255,255,0.03);border-radius:16px;white-space:nowrap}
  .badge-gold{color:var(--gold);border:1px solid rgba(240,165,0,0.2)}
  .badge-teal{color:var(--teal);border:1px solid rgba(26,188,156,0.2)}
  .badge-blue{color:var(--blue);border:1px solid rgba(52,152,219,0.2)}
  .badge-purple{color:var(--purple);border:1px solid rgba(155,89,182,0.2)}
  .badge-green{color:var(--green);border:1px solid rgba(46,204,113,0.2)}
  .badge-cruise{color:var(--cruise);border:1px solid rgba(0,119,182,0.2)}
  .badge-nile{color:var(--nile);border:1px solid rgba(201,162,39,0.2)}

  .card{background:linear-gradient(135deg,rgba(26,26,46,0.9),rgba(22,33,62,0.9));border:1px solid rgba(240,165,0,0.15);border-radius:20px;padding:22px 18px;backdrop-filter:blur(20px);box-shadow:0 16px 50px rgba(0,0,0,0.3)}

  .type-row{display:flex;gap:6px;margin-bottom:16px}
  .type-btn{flex:1;padding:10px 4px;border-radius:10px;cursor:pointer;font-size:11px;font-weight:400;transition:all .2s;font-family:inherit;border:1.5px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.02);color:#888}
  .type-btn.active{border-color:var(--gold);background:rgba(240,165,0,0.12);color:var(--gold);font-weight:700}

  .section-label{font-size:10px;font-weight:600;color:var(--gold);text-transform:uppercase;letter-spacing:.08em;margin-bottom:7px;display:block}
  .airports-grid{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:16px}
  .ap{display:flex;align-items:center;gap:4px;padding:6px 10px;border-radius:8px;border:1.5px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.02);color:#888;cursor:pointer;font-size:11px;font-weight:500;transition:all .2s;user-select:none}
  .ap.on{border-color:var(--gold);background:rgba(240,165,0,0.1);color:var(--gold)}
  .ap .ck{width:14px;height:14px;border-radius:3px;border:1.5px solid currentColor;display:flex;align-items:center;justify-content:center;font-size:8px;flex-shrink:0}
  .ap.on .ck{background:var(--gold);color:#000}

  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
  .grid-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;margin-bottom:14px}
  @media(max-width:500px){.grid-4{grid-template-columns:1fr 1fr}.grid-2{gap:8px}}

  label.f{font-size:10px;font-weight:600;color:var(--gold);text-transform:uppercase;letter-spacing:.06em;margin-bottom:4px;display:block}
  input.fi,select.fi{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(240,165,0,0.25);background:rgba(255,255,255,0.04);color:#f0f0f0;font-size:13px;outline:none;transition:all .3s;font-family:inherit;color-scheme:dark;-webkit-appearance:none}
  input.fi:focus,select.fi:focus{border-color:rgba(240,165,0,0.6);box-shadow:0 0 0 3px rgba(240,165,0,0.1)}
  select.fi{cursor:pointer}option{background:#1a1a2e}

  .btn-main{width:100%;padding:15px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--gold),var(--orange));color:#fff;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;box-shadow:0 4px 20px rgba(240,165,0,0.3);transition:all .3s;-webkit-tap-highlight-color:transparent}
  .btn-main:active{transform:scale(0.98)}.btn-main:disabled{background:rgba(240,165,0,0.3);box-shadow:none;cursor:wait}

  .btn-row{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-top:8px}
  @media(max-width:400px){.btn-row{grid-template-columns:1fr}}
  .btn-s{padding:12px 8px;border-radius:12px;cursor:pointer;font-size:11px;font-weight:600;font-family:inherit;text-align:center;transition:all .3s;-webkit-tap-highlight-color:transparent}
  .btn-s:active{transform:scale(0.97)}.btn-s:disabled{opacity:.4;cursor:wait}
  .b-teal{border:1.5px solid rgba(26,188,156,0.4);background:rgba(26,188,156,0.06);color:var(--teal)}
  .b-blue{border:1.5px solid rgba(52,152,219,0.4);background:rgba(52,152,219,0.06);color:var(--blue)}
  .b-green{border:1.5px solid rgba(46,204,113,0.4);background:rgba(46,204,113,0.06);color:var(--green)}
  .b-purple{border:1.5px solid rgba(155,89,182,0.4);background:rgba(155,89,182,0.06);color:var(--purple)}
  .b-cruise{border:1.5px solid rgba(0,119,182,0.4);background:rgba(0,119,182,0.06);color:var(--cruise)}.b-cruise:hover{background:rgba(0,119,182,0.15)}
  .b-nile{border:1.5px solid rgba(201,162,39,0.4);background:rgba(201,162,39,0.06);color:var(--nile)}.b-nile:hover{background:rgba(201,162,39,0.15)}

  .err{margin-top:12px;padding:10px 14px;border-radius:10px;background:rgba(231,76,60,0.12);border:1px solid rgba(231,76,60,0.3);color:var(--red);font-size:12px}

  .prog{margin-top:18px;border-radius:14px;padding:16px;background:linear-gradient(135deg,rgba(26,26,46,0.9),rgba(22,33,62,0.9));animation:fadeIn .3s}
  .prog h3{margin:0 0 10px;font-size:13px}
  .prog.c-gold{border:1px solid rgba(240,165,0,0.15)}.prog.c-gold h3{color:var(--gold)}
  .prog.c-teal{border:1px solid rgba(26,188,156,0.15)}.prog.c-teal h3{color:var(--teal)}
  .prog.c-blue{border:1px solid rgba(52,152,219,0.15)}.prog.c-blue h3{color:var(--blue)}
  .prog.c-green{border:1px solid rgba(46,204,113,0.15)}.prog.c-green h3{color:var(--green)}
  .prog.c-purple{border:1px solid rgba(155,89,182,0.15)}.prog.c-purple h3{color:var(--purple)}
  .prog.c-cruise{border:1px solid rgba(0,119,182,0.15)}.prog.c-cruise h3{color:var(--cruise)}
  .prog.c-nile{border:1px solid rgba(201,162,39,0.15)}.prog.c-nile h3{color:var(--nile)}

  .ph{display:flex;align-items:center;gap:8px;margin-bottom:7px;transition:all .4s}
  .ph.done{opacity:.5}.ph.wait{opacity:.3}
  .pd{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff;flex-shrink:0}
  .pd.dn{background:var(--green)}.pd.ac{background:var(--gold);animation:pulse 1.5s ease-in-out infinite}.pd.wt{background:#333}
  .pt{font-size:11px;color:#ddd}.pt.ac{font-weight:700}
  .dots{display:inline-flex;gap:2px;align-items:center;margin-left:5px}
  .dots span{width:4px;height:4px;border-radius:50%;background:var(--gold);animation:bounce 1.2s ease-in-out infinite}
  .dots span:nth-child(2){animation-delay:.15s}.dots span:nth-child(3){animation-delay:.3s}

  .tabs{display:flex;gap:5px;margin-bottom:12px;flex-wrap:wrap;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:4px}
  .tab{padding:7px 12px;border-radius:8px;cursor:pointer;font-size:11px;font-family:inherit;white-space:nowrap;border:1.5px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.02);color:#888;font-weight:400;-webkit-tap-highlight-color:transparent}
  .tab.on{border-color:var(--gold);background:rgba(240,165,0,0.12);color:var(--gold);font-weight:700}

  .res-card{background:linear-gradient(135deg,#1a1a2e,#16213e);border:1px solid rgba(240,165,0,0.15);border-radius:14px;padding:18px;overflow-x:auto;animation:fadeIn .4s}
  .res-title{font-family:'Playfair Display',serif;font-size:18px;margin-bottom:12px}
  .res-text{white-space:pre-wrap;color:#e0e0e0;font-size:13px;line-height:1.8;word-wrap:break-word}

  /* Price Table */
  .ptbl{width:100%;border-collapse:separate;border-spacing:0;font-size:11px;border-radius:10px;overflow:hidden;border:1px solid rgba(240,165,0,0.12)}
  .ptbl thead th{background:rgba(240,165,0,0.1);color:var(--gold);padding:10px 6px;font-weight:700;text-align:center;font-size:9px;text-transform:uppercase;letter-spacing:.04em;border-bottom:1px solid rgba(240,165,0,0.15);position:sticky;top:0}
  .ptbl thead th:first-child{text-align:left;min-width:60px}
  .ptbl td{padding:8px 6px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.03);font-size:11px}
  .ptbl td:first-child{text-align:left;font-weight:600;color:#ccc;white-space:nowrap}
  .ptbl tr:hover td{background:rgba(240,165,0,0.04)}
  .p-best{background:rgba(46,204,113,0.15)!important;color:#2ecc71;font-weight:800;border-radius:5px}
  .p-lo{color:#2ecc71;font-weight:700}.p-mid{color:#f39c12;font-weight:600}.p-hi{color:#e74c3c;font-weight:500}
  .legend{display:flex;gap:12px;margin-top:8px;font-size:9px;color:#888;flex-wrap:wrap}
  .legend span{display:flex;align-items:center;gap:3px}
  .ldot{width:8px;height:8px;border-radius:2px}

  .install-banner{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(135deg,rgba(26,26,46,0.98),rgba(22,33,62,0.98));border-top:1px solid rgba(240,165,0,0.2);padding:14px 18px;display:flex;align-items:center;justify-content:space-between;z-index:100;backdrop-filter:blur(20px);padding-bottom:calc(14px + env(safe-area-inset-bottom,0px))}
  .install-banner p{font-size:12px;color:#ccc;flex:1;margin-right:12px}
  .install-banner button{padding:8px 16px;border-radius:8px;border:none;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer}
  .ib-install{background:var(--gold);color:#000;margin-right:8px}
  .ib-close{background:rgba(255,255,255,0.1);color:#888}

  .footer{text-align:center;margin-top:32px;padding-bottom:calc(20px + env(safe-area-inset-bottom,0px))}
  .footer p{color:#444;font-size:10px;line-height:1.5}

  @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
  @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(240,165,0,0.4)}50%{box-shadow:0 0 0 6px rgba(240,165,0,0)}}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  @keyframes bounce{0%,80%,100%{transform:scale(.6);opacity:.4}40%{transform:scale(1);opacity:1}}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="header-icon">üåç</div>
    <h1>ReiseRadar</h1>
    <p>KI-gest√ºtzte Reisesuche ‚Äî Fl√ºge, Hotels, Kreuzfahrten & Nilkreuzfahrten</p>
  </div>

  <div class="badges">
    <span class="badge badge-gold">‚úàÔ∏è Multi-Flughafen</span>
    <span class="badge badge-teal">üìä Preis-Tabelle</span>
    <span class="badge badge-blue">üí∞ G√ºnstigster Monat</span>
    <span class="badge badge-purple">üè® Hotel-Trends</span>
    <span class="badge badge-green">üóìÔ∏è Beste Reisezeit</span>
    <span class="badge badge-cruise">üö¢ Kreuzfahrten</span>
    <span class="badge badge-nile">üèõÔ∏è Nilkreuzfahrt</span>
  </div>

  <div class="card">
    <div class="type-row" id="typeRow">
      <button class="type-btn active" onclick="setType(this,'flight')">‚úàÔ∏è Nur Flug</button>
      <button class="type-btn" onclick="setType(this,'package')">üèñÔ∏è Pauschal</button>
      <button class="type-btn" onclick="setType(this,'both')">üîç Beides</button>
    </div>

    <label class="section-label">Abflugh√§fen</label>
    <div class="airports-grid" id="apGrid"></div>

    <div class="grid-2">
      <div><label class="f">Reiseziel / Land *</label><input class="fi" id="dest" placeholder="z.B. T√ºrkei, Mallorca‚Ä¶"></div>
      <div><label class="f">Region (optional)</label><input class="fi" id="region" placeholder="z.B. Antalya, Palma‚Ä¶"></div>
    </div>
    <div class="grid-2">
      <div><label class="f">Hinflug</label><input type="date" class="fi" id="dep"></div>
      <div><label class="f">R√ºckflug</label><input type="date" class="fi" id="ret"></div>
    </div>
    <div class="grid-4">
      <div><label class="f">Reisende</label><select class="fi" id="trav"><option value="1">1</option><option value="2" selected>2</option><option value="3">3</option><option value="4">4</option></select></div>
      <div><label class="f">Budget ‚Ç¨/P.</label><input type="number" class="fi" id="budget" placeholder="500"></div>
      <div><label class="f">Flexibel</label><select class="fi" id="flex"><option value="exact">Exakt</option><option value="3days">¬±3T</option><option value="7days" selected>¬±7T</option></select></div>
      <div><label class="f">Sterne</label><select class="fi" id="stars"><option value="3">‚≠ê3</option><option value="4" selected>‚≠ê4</option><option value="5">‚≠ê5</option></select></div>
    </div>

    <button class="btn-main" id="btnSearch" onclick="doSearch()">üöÄ G√ºnstigste Angebote finden</button>
    <div class="btn-row">
      <button class="btn-s b-teal" id="btnTable" onclick="doTable()">üìä Jahres-Preistabelle</button>
      <button class="btn-s b-blue" id="btnCheap" onclick="doCheap()">üí∞ G√ºnstigster Zeitraum</button>
    </div>
    <div class="btn-row">
      <button class="btn-s b-green" id="btnTime" onclick="doTime()">üóìÔ∏è Beste Reisezeit</button>
      <button class="btn-s b-purple" id="btnHotel" onclick="doHotel()">üè® Hotel-Trends</button>
    </div>

    <!-- Cruise Section -->
    <div style="margin-top:14px;padding-top:14px;border-top:1px solid rgba(255,255,255,0.06)">
      <label class="section-label" style="margin-bottom:10px">üö¢ Kreuzfahrten</label>
      <div class="grid-4" style="margin-bottom:10px">
        <div><label class="f">Dauer (N√§chte)</label><select class="fi" id="crDur"><option value="any">Egal</option><option value="3-5">3-5</option><option value="7" selected>7</option><option value="10-14">10-14</option><option value="14+">14+</option></select></div>
        <div><label class="f">Kabine</label><select class="fi" id="crCabin"><option value="innen">Innen</option><option value="aussen" selected>Au√üen</option><option value="balkon">Balkon</option><option value="suite">Suite</option></select></div>
        <div><label class="f">Reederei</label><select class="fi" id="crLine"><option value="any" selected>Alle</option><option value="AIDA">AIDA</option><option value="MSC">MSC</option><option value="Costa">Costa</option><option value="TUI">TUI Cruises</option><option value="Royal Caribbean">Royal Carib.</option><option value="Norwegian">Norwegian</option></select></div>
        <div><label class="f">Verpflegung</label><select class="fi" id="crBoard"><option value="any">Egal</option><option value="all-inclusive" selected>All-Inclusive</option><option value="vollpension">Vollpension</option></select></div>
      </div>
      <div class="btn-row">
        <button class="btn-s b-cruise" id="btnCruise" onclick="doCruise()">üö¢ Kreuzfahrt-Schn√§ppchen</button>
        <button class="btn-s b-nile" id="btnNile" onclick="doNile()">üèõÔ∏è Nilkreuzfahrt finden</button>
      </div>
    </div>
    <div id="errBox" class="err" style="display:none"></div>
  </div>

  <div id="progArea"></div>
  <div id="resArea" style="margin-top:18px"></div>
  <div class="footer"><p>ReiseRadar durchsucht das Web mit KI. Preise variieren ‚Äî Buchung beim Anbieter.</p></div>
</div>

<!-- Install Banner for iOS -->
<div class="install-banner" id="installBanner" style="display:none">
  <p>üì± <strong>Zum Home-Bildschirm hinzuf√ºgen</strong> f√ºr schnellen Zugriff!</p>
  <button class="ib-install" onclick="showInstallHelp()">Wie?</button>
  <button class="ib-close" onclick="closeBanner()">‚úï</button>
</div>

<script>
// ‚ïê‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê
const AIRPORTS=[
  {code:'DUS',name:'D√ºsseldorf',on:true},{code:'CGN',name:'K√∂ln/Bonn',on:true},
  {code:'FRA',name:'Frankfurt',on:true},{code:'DTM',name:'Dortmund',on:false},
  {code:'AMS',name:'Amsterdam',on:true},{code:'BRU',name:'Br√ºssel',on:true},
  {code:'CRL',name:'Charleroi',on:false},{code:'EIN',name:'Eindhoven',on:false}
];
const LABELS={search:'üîé Angebote',table:'üìä Preistabelle',cheap:'üí∞ G√ºnstigster Zeitraum',time:'üóìÔ∏è Beste Reisezeit',hotel:'üè® Hotel-Trends',cruise:'üö¢ Kreuzfahrten',nile:'üèõÔ∏è Nilkreuzfahrt'};
const COLORS={search:'#f0a500',table:'#1abc9c',cheap:'#3498db',time:'#2ecc71',hotel:'#9b59b6',cruise:'#0077b6',nile:'#c9a227'};
const PHASES={
  search:['Durchsuche Portale‚Ä¶','Vergleiche Preise‚Ä¶','Erstelle Ranking‚Ä¶'],
  table:['Recherchiere Preise je Monat‚Ä¶','Vergleiche Flugh√§fen‚Ä¶','Erstelle Tabelle‚Ä¶'],
  cheap:['Analysiere Preisverl√§ufe‚Ä¶','Vergleiche Monate‚Ä¶','Erstelle Empfehlung‚Ä¶'],
  time:['Recherchiere Klima‚Ä¶','Pr√ºfe Saisons‚Ä¶','Erstelle Empfehlung‚Ä¶'],
  hotel:['Durchsuche Portale‚Ä¶','Analysiere Bewertungen‚Ä¶','Erstelle Ranking‚Ä¶'],
  cruise:['Durchsuche Kreuzfahrt-Portale‚Ä¶','Vergleiche Routen & Preise‚Ä¶','Analysiere Bewertungen & beste Zeit‚Ä¶'],
  nile:['Suche Nilkreuzfahrt-Angebote‚Ä¶','Vergleiche Schiffe & Bewertungen‚Ä¶','Analysiere Preise & beste Reisezeit‚Ä¶']
};

let type='flight',store={},tab='',busy=false,phaseIv=null;

// ‚ïê‚ïê‚ïê INIT AIRPORTS ‚ïê‚ïê‚ïê
const apGrid=document.getElementById('apGrid');
AIRPORTS.forEach(a=>{
  const d=document.createElement('div');
  d.className='ap'+(a.on?' on':'');d.dataset.code=a.code;
  d.innerHTML=`<span class="ck">${a.on?'‚úì':''}</span> ${a.name}`;
  d.onclick=()=>{d.classList.toggle('on');d.querySelector('.ck').textContent=d.classList.contains('on')?'‚úì':''};
  apGrid.appendChild(d);
});

function setType(b,t){document.querySelectorAll('.type-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');type=t}
function getAP(){return Array.from(document.querySelectorAll('.ap.on')).map(d=>({code:d.dataset.code,name:d.textContent.replace('‚úì','').trim()}))}
function g(id){return document.getElementById(id).value.trim()}
function err(m){const e=document.getElementById('errBox');e.style.display='block';e.textContent=m;setTimeout(()=>e.style.display='none',5000)}
function lock(s){busy=s;['btnSearch','btnTable','btnCheap','btnTime','btnHotel','btnCruise','btnNile'].forEach(id=>document.getElementById(id).disabled=s)}

// ‚ïê‚ïê‚ïê PROGRESS ‚ïê‚ïê‚ïê
function showProg(key){
  const ps=PHASES[key]||[],col=COLORS[key]||'#f0a500',cls='c-'+Object.keys(COLORS).find(k=>COLORS[k]===col);
  document.getElementById('progArea').innerHTML=`<div class="prog ${cls}"><h3>${LABELS[key]||''} ‚Äî ${g('dest')}‚Ä¶</h3><div id="phs">${ps.map((p,i)=>`<div class="ph ${i?'wait':''}" id="p${i}"><div class="pd ${i?'wt':'ac'}">${i+1}</div><span class="pt ${i?'':'ac'}">${p}${i?'':'<span class="dots"><span></span><span></span><span></span></span>'}</span></div>`).join('')}</div></div>`;
  let c=0;
  phaseIv=setInterval(()=>{c++;if(c>=ps.length)return;for(let i=0;i<ps.length;i++){const el=document.getElementById('p'+i);if(!el)continue;const d=el.querySelector('.pd'),t=el.querySelector('.pt');if(i<c){el.className='ph done';d.className='pd dn';d.textContent='‚úì';t.className='pt';t.textContent=ps[i]}else if(i===c){el.className='ph';d.className='pd ac';d.textContent=i+1;t.className='pt ac';t.innerHTML=ps[i]+'<span class="dots"><span></span><span></span><span></span></span>'}}},4500);
}
function hideProg(){clearInterval(phaseIv);document.getElementById('progArea').innerHTML=''}

// ‚ïê‚ïê‚ïê RENDER RESULTS ‚ïê‚ïê‚ïê
function render(){
  const a=document.getElementById('resArea'),keys=Object.keys(store);
  if(!keys.length){a.innerHTML='';return}
  if(!tab||!store[tab])tab=keys[keys.length-1];
  const col=COLORS[tab]||'#f0a500';
  let h='<div style="animation:fadeIn .4s"><div class="tabs">';
  keys.forEach(k=>{h+=`<button class="tab ${tab===k?'on':''}" onclick="tab='${k}';render()">${LABELS[k]||k}</button>`});
  h+=`</div><h2 class="res-title" style="color:${col}">${LABELS[tab]} ‚Äî ${g('dest')}</h2><div class="res-card">`;
  if(tab==='table')h+=buildTable(store.table);
  else h+=`<div class="res-text">${fmt(store[tab])}</div>`;
  h+='</div></div>';a.innerHTML=h;a.scrollIntoView({behavior:'smooth',block:'start'});
}

function fmt(t){return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/(https?:\/\/[^\s<]+)/g,'<a href="$1" target="_blank" rel="noopener" style="color:var(--gold);word-break:break-all">$1</a>')}

// ‚ïê‚ïê‚ïê TABLE PARSER ‚ïê‚ïê‚ïê
function buildTable(raw){
  let td='',sum='';const ts=raw.indexOf('TABELLE_START'),te=raw.indexOf('TABELLE_ENDE');
  if(ts>-1&&te>-1){td=raw.substring(ts+13,te).trim();sum=raw.substring(te+12).trim()}
  else{const pl=raw.split('\n').filter(l=>l.includes('|')&&l.length>5);if(pl.length>1){td=pl.join('\n');sum=raw.substring(raw.lastIndexOf(pl[pl.length-1])+pl[pl.length-1].length).trim()}else return`<div class="res-text">${fmt(raw)}</div>`}
  const rows=td.split('\n').map(r=>r.trim()).filter(r=>r.includes('|'));
  if(rows.length<2)return`<div class="res-text">${fmt(raw)}</div>`;
  const hd=rows[0].split('|').map(c=>c.trim());
  let all=[];const dr=rows.slice(1).map(r=>{const c=r.split('|').map(x=>x.trim());c.forEach((x,j)=>{if(j>0&&j<c.length-1){const p=pp(x);if(p>0)all.push(p)}});return c});
  all.sort((a,b)=>a-b);const lo=all.length?all[Math.floor(all.length*.33)]:0,mid=all.length?all[Math.floor(all.length*.66)]:0,best=all.length?all[0]:0;
  let h='<div style="overflow-x:auto"><table class="ptbl"><thead><tr>';
  hd.forEach(c=>{h+=`<th>${esc(c)}</th>`});h+='</tr></thead><tbody>';
  dr.forEach(cells=>{h+='<tr>';cells.forEach((c,j)=>{
    if(j===0)h+=`<td>${esc(c)}</td>`;
    else if(j===cells.length-1)h+=`<td style="font-size:10px">${esc(c)}</td>`;
    else{const p=pp(c);let cls='';if(p>0){if(p<=best*1.05)cls='p-best';else if(p<=lo)cls='p-lo';else if(p<=mid)cls='p-mid';else cls='p-hi'}
    h+=`<td class="${cls}">${esc(c.replace('>>>','‚ñ∂').replace('***','‚òÖ'))}</td>`}
  });h+='</tr>'});
  h+='</tbody></table></div>';
  h+='<div class="legend"><span><span class="ldot" style="background:#2ecc71"></span>G√ºnstig</span><span><span class="ldot" style="background:#f39c12"></span>Mittel</span><span><span class="ldot" style="background:#e74c3c"></span>Teuer</span><span><span class="ldot" style="background:rgba(46,204,113,0.3);border:2px solid #2ecc71"></span>Bester</span></div>';
  if(sum)h+=`<div style="margin-top:14px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.05)"><div class="res-text">${fmt(sum)}</div></div>`;
  return h;
}
function pp(s){const m=s.replace(/[^\d]/g,'');return m?parseInt(m):0}
function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

// ‚ïê‚ïê‚ïê API ‚ïê‚ïê‚ïê
async function ai(prompt){
  const r=await fetch('/api/search',{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:4000,messages:[{role:'user',content:prompt}],tools:[{type:'web_search_20250305',name:'web_search'}]})
  });
  const d=await r.json();if(d.error)throw new Error(typeof d.error==='string'?d.error:d.error.message||'API Fehler');
  return d.content.filter(b=>b.type==='text').map(b=>b.text).join('\n');
}

async function run(key,prompt,btnId,label){
  if(!g('dest')&&key!=='nile'){err('Bitte Reiseziel eingeben.');return}
  if(key==='search'&&!g('dep')){err('Bitte Hinflugdatum eingeben.');return}
  const aps=getAP();if(key==='table'&&!aps.length){err('Bitte Flughafen w√§hlen.');return}
  lock(true);document.getElementById(btnId).textContent='‚è≥ L√§uft‚Ä¶';showProg(key);
  try{const t=await ai(prompt);store[key]=t||'Keine Ergebnisse.';tab=key}
  catch(e){err('Fehler: '+e.message)}
  finally{hideProg();lock(false);document.getElementById(btnId).textContent=label;render()}
}

// ‚ïê‚ïê‚ïê ACTIONS ‚ïê‚ïê‚ïê
function apStr(){const a=getAP();return a.map(x=>x.name+' ('+x.code+')').join(', ')||'Deutschland'}
function apCodes(){return getAP().map(x=>x.code).join(', ')}
function tLabel(){return type==='flight'?'Nur Fl√ºge':type==='package'?'Pauschalreisen':'Fl√ºge+Pauschal'}
function fLabel(){const f=g('flex');return f==='exact'?'exakt':'¬±'+f.replace('days','')+'T'}

function doSearch(){run('search',`Reiseexperte: G√ºnstigste Angebote nach ${g('dest')}${g('region')?', '+g('region'):''}.
ABFLUGH√ÑFEN: ${apStr()}
HINFLUG: ${g('dep')}, R√úCKFLUG: ${g('ret')||'offen'}, REISENDE: ${g('trav')}, TYP: ${tLabel()}, FLEX: ${fLabel()}
BUDGET: ${g('budget')?g('budget')+'‚Ç¨/P.':'offen'}
${type!=='flight'?'MIN STERNE: '+g('stars'):''}
Suche auf Skyscanner, Google Flights, Kayak, Check24, HolidayCheck, lastminute.de.
Auf Deutsch: ‚úàÔ∏è FLUGHAFEN-VERGLEICH, üèÜ TOP ANGEBOTE (Preis, Airline, ${type!=='flight'?'Hotel+Bewertung,':''} Link), üí° SPAR-TIPPS`,'btnSearch','üöÄ G√ºnstigste Angebote finden')}

function doTable(){const heads=getAP().map(x=>x.name+' ('+x.code+')');
run('table',`Flugpreis-Analyst: Preistabelle f√ºr ${g('dest')}${g('region')?', '+g('region'):''}.
ABFLUGH√ÑFEN: ${heads.join(', ')}
TYP: ${type==='flight'?'Flug':'Pauschal'}, REISENDE: ${g('trav')}
${type!=='flight'?'MIN STERNE: '+g('stars'):''}

Antworte EXAKT so:
TABELLE_START
Monat|${heads.join('|')}|Bewertung
Jan|XXX‚Ç¨|${heads.slice(1).map(()=>'XXX‚Ç¨').join('|')}|üü¢/üü°/üî¥
Feb|...|...|...
M√§r|...|...|...
Apr|...|...|...
Mai|...|...|...
Jun|...|...|...
Jul|...|...|...
Aug|...|...|...
Sep|...|...|...
Okt|...|...|...
Nov|...|...|...
Dez|...|...|...
TABELLE_ENDE

Preise PRO PERSON ‚Ç¨ f√ºr Hin+R√ºck ~7T.${type!=='flight'?' Pauschal: inkl. Hotel/7N.':''}
Markiere g√ºnstigsten mit >>>.
Danach: üèÜ G√ºnstigster Monat+Flughafen, ü•à Zweit, ‚ö†Ô∏è Teuerster, üí° Spartipp, üìÖ Buchungszeit`,'btnTable','üìä Jahres-Preistabelle')}

function doCheap(){run('cheap',`Flugpreis-Experte: Wann am g√ºnstigsten nach ${g('dest')}?
Abflugh√§fen: ${apStr()}. Reisende: ${g('trav')}${g('budget')?', Budget: '+g('budget')+'‚Ç¨/P.':''}
Auf Deutsch: 1.Preis je Monat(üü¢/üü°/üî¥+Preis) 2.Flughafen-Vergleich 3.Beste Wochentage 4.Buchungszeit 5.‚úÖG√ºnstigste Kombi`,'btnCheap','üí∞ G√ºnstigster Zeitraum')}

function doTime(){run('time',`Reiseexperte: Beste Reisezeit f√ºr ${g('dest')}?
Auf Deutsch: 1.Klima&Wetter 2.G√ºnstigste Reisezeit 3.Events 4.Hinweise(Visum etc.) 5.‚úÖEmpfehlung`,'btnTime','üóìÔ∏è Beste Reisezeit')}

function doHotel(){run('hotel',`Hotel-Experte: Beste Hotels in ${g('dest')}${g('region')?', '+g('region'):''} mit mind. ${g('stars')} Sternen.
${g('dep')?'Zeitraum: '+g('dep')+(g('ret')?' bis '+g('ret'):''):''} ${g('budget')?'Budget: max.'+g('budget')+'‚Ç¨/P.':''} F√ºr ${g('trav')} Pers.
Auf TripAdvisor, Booking.com, HolidayCheck.
5-8 Hotels: Name,Sterne,Lage,Bewertungen,Preis,Highlights.
üìä BEWERTUNGS-TRENDS: üëçTop3 Lob(%), üëéTop3 Kritik(%), üí¨G√§ste-Zitat, ‚úÖEmpfohlen f√ºr
üèÜ RANKING: Gesamtpaket,Strand,Familie,Luxus,Geheimtipp üí°Buchungstipps`,'btnHotel','üè® Hotel-Trends')}

// ‚ïê‚ïê‚ïê üö¢ KREUZFAHRTEN ‚ïê‚ïê‚ïê
function doCruise(){
  const dest=g('dest'), dur=g('crDur'), cabin=g('crCabin'), line=g('crLine'), board=g('crBoard');
  if(!dest){err('Bitte Reiseziel/Region eingeben (z.B. Mittelmeer, Karibik, Norwegen‚Ä¶)');return}
  run('cruise',`Du bist ein Kreuzfahrt-Experte. Suche im Web nach den besten und g√ºnstigsten Kreuzfahrt-Angeboten.

REISEZIEL / ROUTE: ${dest}${g('region')?', '+g('region'):''}
ABFAHRT AB: ${apStr()} (oder n√§chstgelegener Kreuzfahrthafen)
REISEDAUER: ${dur==='any'?'egal':dur+' N√§chte'}
KABINENTYP: ${cabin}
REEDEREI: ${line==='any'?'Alle Reedereien':line}
VERPFLEGUNG: ${board==='any'?'egal':board}
REISENDE: ${g('trav')} Person(en)
${g('dep')?'WUNSCHZEITRAUM: '+g('dep')+(g('ret')?' bis '+g('ret'):''):'ZEITRAUM: Flexibel'}
${g('budget')?'BUDGET: max. '+g('budget')+'‚Ç¨ pro Person':''}

Suche auf: kreuzfahrten.de, AIDA.de, MSC, Costa, TUI Cruises, Dreamlines, e-hoi, Kreuzfahrtberater, Check24 Kreuzfahrten, Mein Schiff.

Antworte auf Deutsch:

üö¢ TOP KREUZFAHRT-ANGEBOTE (sortiert nach Preis)

F√ºr jedes Angebot (mind. 5-8):
**Reederei ‚Äî Schiffsname**
üó∫Ô∏è Route: Abfahrtshafen ‚Üí Stopps ‚Üí R√ºckkunft
üìÖ Reisedaten & Dauer
üõèÔ∏è Kabine: Typ & Ausstattung
üçΩÔ∏è Verpflegung: All-Inclusive / Vollpension / etc.
üí∞ Preis: ab XX‚Ç¨ pro Person (Gesamtpreis f√ºr ${g('trav')} Pers.)
‚≠ê Bewertung: Schiff-Bewertung + G√§ste-Feedback
‚úÖ Highlights: Was macht diese Kreuzfahrt besonders?
üîó Portal & Link

üìä PREIS-VERGLEICH NACH REEDEREI
Vergleiche die g√ºnstigsten Angebote je Reederei f√ºr diese Route.

üóìÔ∏è BESTE & G√úNSTIGSTE ZEIT F√úR DIESE KREUZFAHRT
- Welche Monate sind am g√ºnstigsten? (Nebensaison)
- Welche Monate sind am besten? (Wetter, Erlebnis)
- Preisunterschied Hoch- vs. Nebensaison in %
- Fr√ºhbucher vs. Last-Minute ‚Äî was lohnt sich?

üèÜ EMPFEHLUNG
1. üí∞ Bestes Schn√§ppchen (g√ºnstigster Preis)
2. ‚≠ê Bestes Preis-Leistungs-Verh√§ltnis
3. üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Beste Familienkreuzfahrt
4. üíé Beste Luxus-Kreuzfahrt

üí° BUCHUNGSTIPPS
- Welches Portal ist am g√ºnstigsten?
- Kabinen-Upgrade-Tricks?
- Bordguthaben/Inklusivleistungen beachten

Sei so konkret wie m√∂glich mit echten Preisen, Schiffen und Daten.`,'btnCruise','üö¢ Kreuzfahrt-Schn√§ppchen')}

// ‚ïê‚ïê‚ïê üèõÔ∏è NILKREUZFAHRT ‚ïê‚ïê‚ïê
function doNile(){
  const dur=g('crDur'), cabin=g('crCabin'), board=g('crBoard');
  run('nile',`Du bist ein √Ñgypten- und Nilkreuzfahrt-Experte. Suche im Web nach den besten Nilkreuzfahrt-Angeboten.

REISE: Nilkreuzfahrt in √Ñgypten ${g('dest')?'('+g('dest')+')':''}
ABFLUG AB: ${apStr()}
REISEDAUER: ${dur==='any'?'typisch 4-7 N√§chte auf dem Nil (+Aufenthalt)':dur+' N√§chte'}
KABINENTYP: ${cabin}
VERPFLEGUNG: ${board==='any'?'Vollpension/All-Inclusive':board}
REISENDE: ${g('trav')} Person(en)
${g('dep')?'WUNSCHZEITRAUM: '+g('dep')+(g('ret')?' bis '+g('ret'):''):'ZEITRAUM: Flexibel ‚Äî suche auch die g√ºnstigsten Monate!'}
${g('budget')?'BUDGET: max. '+g('budget')+'‚Ç¨ pro Person (inkl. Flug)':''}

Suche auf: FTI, DERTOUR, TUI, Lidl Reisen, Neckermann, Check24, ab-in-den-urlaub, Berge&Meer, 5vorFlug, Sonnenklar.tv, Nilkreuzfahrt-Spezialisten.

Antworte auf Deutsch:

üèõÔ∏è TOP NILKREUZFAHRT-ANGEBOTE

F√ºr jedes Angebot (mind. 5-8):
**Veranstalter ‚Äî Schiffsname** ‚≠ê‚≠ê‚≠ê‚≠ê(‚≠ê)
üó∫Ô∏è Route: z.B. Luxor ‚Üí Edfu ‚Üí Kom Ombo ‚Üí Assuan (oder umgekehrt)
üìÖ Reisedaten & Dauer (Tage auf dem Nil + evtl. Badeverl√§ngerung)
‚úàÔ∏è Flug inklusive? Ab welchem Flughafen?
üõèÔ∏è Kabine: Typ, Gr√∂√üe, Ausstattung
üçΩÔ∏è Verpflegung: VP/AI + Getr√§nke?
üèõÔ∏è Ausfl√ºge inklusive? Welche? (Tal der K√∂nige, Karnak, Philae etc.)
üí∞ Preis: ab XX‚Ç¨ pro Person INKL. FLUG
‚≠ê Schiffsbewertung: X/6 auf HolidayCheck, X/10 auf TripAdvisor
üîó Portal & Link

üìä BEWERTUNGS-TRENDS DER BESTEN NILKREUZFAHRT-SCHIFFE
F√ºr die Top 3-5 Schiffe:
- üëç Was G√§ste am meisten loben (%, Themen)
- üëé H√§ufigste Kritik (%, Themen)
- üí¨ Typisches G√§ste-Zitat
- ‚úÖ Empfohlen f√ºr: Paare/Familien/Kultur-Interessierte

üóìÔ∏è BESTE & G√úNSTIGSTE REISEZEIT F√úR NILKREUZFAHRTEN
- üå°Ô∏è Wetter nach Monat (Temperaturen am Nil, Hitze im Sommer?)
- üí∞ G√ºnstigste Monate (Preise Nebensaison vs. Hochsaison)
- üü¢ G√ºnstig: welche Monate, ca. Preis
- üü° Mittel: welche Monate, ca. Preis
- üî¥ Teuer: welche Monate, ca. Preis
- ‚úÖ Perfekter Zeitraum (Wetter + Preis + wenig Touristen)
- ‚ö†Ô∏è Meiden: Welche Monate und warum (Hitze >45¬∞C etc.)

üèÜ EMPFEHLUNG
1. üí∞ G√ºnstigstes Angebot
2. ‚≠ê Bestes Preis-Leistungs-Verh√§ltnis
3. üíé Bestes Luxus-Schiff
4. üèñÔ∏è Beste Kombi Nilkreuzfahrt + Badeurlaub (z.B. + Hurghada/Marsa Alam)

üí° BUCHUNGSTIPPS
- Fr√ºhbucher oder Last-Minute?
- Visum, Impfungen, Sicherheit?
- Trinkgeld-Kultur auf dem Schiff?
- Lohnt sich Badeverl√§ngerung am Roten Meer?

Sei so konkret wie m√∂glich mit echten Preisen, Schiffen und Portalen.`,'btnNile','üèõÔ∏è Nilkreuzfahrt finden')}
// ‚ïê‚ïê‚ïê PWA INSTALL ‚ïê‚ïê‚ïê
const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent);
const isStandalone=window.matchMedia('(display-mode:standalone)').matches||window.navigator.standalone;
if(isIOS&&!isStandalone){setTimeout(()=>document.getElementById('installBanner').style.display='flex',2000)}

function showInstallHelp(){
  alert('So f√ºgst du ReiseRadar zum Home-Bildschirm hinzu:\n\n1. Tippe auf das Teilen-Symbol (üì§) unten in Safari\n2. Scrolle nach unten\n3. Tippe auf "Zum Home-Bildschirm"\n4. Tippe auf "Hinzuf√ºgen"\n\nFertig! ReiseRadar erscheint als App auf deinem Home-Bildschirm.');
}
function closeBanner(){document.getElementById('installBanner').style.display='none'}

// Service Worker for PWA
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('data:text/javascript,'+encodeURIComponent(`
    self.addEventListener('fetch',e=>e.respondWith(fetch(e.request).catch(()=>new Response('Offline - bitte Internetverbindung pr√ºfen',{headers:{'Content-Type':'text/plain'}}))));
  `)).catch(()=>{});
}
</script>
</body>
</html>
